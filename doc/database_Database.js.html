<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: database/Database.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: database/Database.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const debug = require('debug')('server:database');
const mongoose = require('mongoose');
const models = require('./models');
const config = require('../config');
const userConfig = config.databaseModels.User;
const itemConfig = config.databaseModels.Item;
const eventConfig = config.databaseModels.Event;
const utils = require('./DatabaseUtils');

class Database {
  /**
   * The constructor initializes a connection to the MongoDB at the url
   * specified in configuration.
   * 
   * @see config.js
   */
  constructor() {
    // initialize connection status
    this.connected = false;

    // connect to db
    mongoose.connect(config.databaseUrl, {
      useCreateIndex: true,
      useNewUrlParser: true
    });
    this.db = mongoose.connection;
    this.db.on('error', console.error.bind(console, 'connection error:'));
    this.db.once('open', () => {
      // set connection status to be successful
      this.connected = true;
      debug('connected to mongodb: ', config.databaseUrl);
    });
  }

  fetchData(user, callback = () => {}) {
    utils.authorize(user, callback, () => {
      utils.getItems(user.facebookId, itemsResult => {
        if (!(itemsResult.success)) {
          callback(itemsResult);
        } else {
          utils.getEvents(user.facebookId, eventsResult => {
            if (!(eventsResult.success)) {
              callback(eventsResult);
            } else {
              callback({
                success: true,
                items: itemsResult.items,
                events: eventsResult.events
              });
            }
          })
        }
      });
    });
  }

  insertUser(user, callback = () => {}) {
    utils.insertIfNotExisting(models.User, userConfig.primaryKey, user, callback);
  }

  insertItem(user, item, callback = () => {}) {
    utils.authorize(user, callback, () => {
      utils.insert(models.Item, item, callback);
    });
  }

  insertEvent(user, event, callback = () => {}) {
    utils.authorize(user, callback, () => {
      utils.insert(models.Event, event, callback);
    });
  }

  updateUser(user, callback = () => {}) {
    utils.authorize(user, callback, () => {
      utils.update(models.User, userConfig.primaryKey, user, callback);
    });
  }

  updateItem(user, item, callback = () => {}) {
    utils.authorize(user, callback, () => {
      utils.update(models.Item, itemConfig.primaryKey, item, callback);
    });
  }

  updateEvent(user, event, callback = () => {}) {
    utils.authorize(user, callback, () => {
      utils.update(models.Event, eventConfig.primaryKey, event, callback);
    });
  }

  removeUser(user, callback = () => {}) {
    utils.authorize(user, callback, () => {
      utils.remove(models.User, userConfig.primaryKey, user, callback);
    });
  }

  removeItem(user, item, callback = () => {}) {
    utils.authorize(user, callback, () => {
      utils.remove(models.Item, itemConfig.primaryKey, item, callback);
    });
  }

  removeEvent(user, event, callback = () => {}) {
    utils.remove(models.Event, eventConfig.primaryKey, event, callback);
  }
}

module.exports = new Database();

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Database.html">Database</a></li><li><a href="Query.html">Query</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Nov 15 2018 14:26:36 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
